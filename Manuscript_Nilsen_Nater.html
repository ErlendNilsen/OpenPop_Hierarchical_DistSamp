<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Erlend B. Nilsen &amp; Chloé R. Nater">

<title>An integrated open population distance sampling approach for modelling age-structured populations</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="Manuscript_Nilsen_Nater_files/libs/clipboard/clipboard.min.js"></script>
<script src="Manuscript_Nilsen_Nater_files/libs/quarto-html/quarto.js"></script>
<script src="Manuscript_Nilsen_Nater_files/libs/quarto-html/popper.min.js"></script>
<script src="Manuscript_Nilsen_Nater_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Manuscript_Nilsen_Nater_files/libs/quarto-html/anchor.min.js"></script>
<link href="Manuscript_Nilsen_Nater_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Manuscript_Nilsen_Nater_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Manuscript_Nilsen_Nater_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Manuscript_Nilsen_Nater_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Manuscript_Nilsen_Nater_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">An integrated open population distance sampling approach for modelling age-structured populations</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Erlend B. Nilsen &amp; Chloé R. Nater </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="abstract" class="level2">
<h2 class="anchored" data-anchor-id="abstract">Abstract</h2>
<p><em>Estimation of abundance and demographic rates for populations of wild vertebrate species is a challenging but fundamental issue for both management and research into ecology and evolution. One approach that has been used extensively to estimate abundance of wild living populations is Distance Sampling (DS) methods based on line transect survey data. Historically, DS models were only available as open population models, and did not allow for the direct estimation of changes in abundance through time. The advent of open population formulations based on the DS framework greatly extended the scope of the models, but so far models that estimate both temporal dynamics in abundance as well as the underlying demographic rates has not been implemented. Here, we present an integrated distance sampling approach, that utilize age-structured survey data and auxiliary data from marked individuals to jointly estimate population dynamics and the temporal variation in the demographic rates (recruitment rate and survival probability) that determine the temporal transition. The underlying process model is based on a two-stage transition matrix (</em><span class="math inline">\(A_t\)</span><em>), with matrix entries given by survival probabilities (</em><span class="math inline">\(S\)</span><em>) and time-specific recruitment rates (</em><span class="math inline">\(R_t\)</span><em>). This framework allow us to make full use of the available data, and to effectively integrate the two data sources in an integrated modelling framework. Moreover, demographic rates often respond to environmental variation, and our approach allow us to directly estimate the effect of such environmental covariates on demographic rate variation. We first fit the model to simulated data, to assess it’s ability to recover the underlying population dynamics when the true values are known. Then, we use data from a study of willow ptarmigan (Lagopus lagopus) in Norway as a case study.</em></p>
</section>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">1. Introduction</h2>
<p>Estimating abundance and demographic rates for wildlife populations is an integral part of basic and applied ecology <span class="citation" data-cites="Skalski2005">Williams, Nichols, and Conroy (<a href="#ref-williams2002" role="doc-biblioref">2002</a>)</span>. Over the last few decades, tremendous progress has been made towards this end. This progress is partly driven the development and application of new field data collection methods and approaches, such as citizen science data (ref), camera trap data (ref) and the collection of environmental DNA data (ref). In addition, developments of novel statistical methods alongside decreases in computational costs now allow researchers to estimate abundance and demographic rates in situations where it was not feasible before (ref). Combined, these advances put us in a much better position for estimating quantities needed for population management <span class="citation" data-cites="williams2002">(<a href="#ref-williams2002" role="doc-biblioref">Williams, Nichols, and Conroy 2002</a>)</span> and indices relevant for large scale policy applications, e.g.&nbsp;Essential Biodiversity Variables <span class="citation" data-cites="Kissling2018">(<a href="#ref-Kissling2018" role="doc-biblioref">Kissling et al. 2018</a>)</span>.</p>
<p>Until recently, joint estimation of population dynamics and demography has relied mostly on data from marked individuals through application of open-population capture-mark-recapture models <span class="citation" data-cites="schaub2021">(<a href="#ref-schaub2021" role="doc-biblioref">Schaub and Kéry 2021</a>)</span>. While such methods can provide valuable information for both ecological research and management, collecting the necessary data is typically costly and logistically challenging to implement over large areas. Monitoring focusing on abundance trends over larger areas, on the other hand, are typically based on data from unmarked animals (ref). A common approach for such surveys is to structure data collection around the distance sampling (DS) method. DS has been used for estimating animal abundance in a wide range of contexts and for a variety of taxa <span class="citation" data-cites="buckland2015">(<a href="#ref-buckland2015" role="doc-biblioref">Buckland et al. 2015</a>)</span>. One reason for the method’s popularity is that it does not require repeated visits to the same sites for estimating detection probability. This makes DS particularly useful for implementation in participatory monitoring programs, allowing stakeholders to take part in the data collection process.</p>
<p>The most common implementations of DS models have long used close-population formulations, and thus do not allow formulating a process model that projects abundance across years based on estimates of population growth rate (<span class="math inline">\(\lambda\)</span>) or underlying demographic rates <span class="citation" data-cites="buckland2015">Buckland et al. (<a href="#ref-buckland2015" role="doc-biblioref">2015</a>)</span>. In recent years, DS approaches have been extended in many ways, including applications that estimate changes in abundance over time in open populations via a hidden state model representing population dynamics <span class="citation" data-cites="moore2011 sollmann2015">(<a href="#ref-moore2011" role="doc-biblioref">Moore and Barlow 2011</a>; <a href="#ref-sollmann2015" role="doc-biblioref">Sollmann et al. 2015</a>)</span>. This has greatly extended the potential of DS approaches for studying ecological dynamics across time and space. However, while these latter frameworks may allow to accurately quantify population changes, they typically provide little information on the drivers of these changes, i.e.&nbsp;the underlying vital rates. In fact, if the data does not contain information about the age (and/or sex-) structure of the surveyed population, there is no straightforward way to estimate demographic rates from such data. On the contrary, if age (and sex) of detected individuals can be determined, this information can be used to provide information on recruitment rates and survival probabilities. <span class="citation" data-cites="Nilsen2018">Nilsen and Strand (<a href="#ref-Nilsen2018" role="doc-biblioref">2018</a>)</span>, for example, used a model based on harvest statistics and observations of population age structure to estimate population abundance and demographic rates without the need for any additional data from marked individuals.</p>
<p>Concurrent with the development of more sophisticated DS models, another group of models has emerged and rapidly gained popularity, not least for their ability to disentangle demographic processes underlying population dynamic: integrated population models <span class="citation" data-cites="schaub2021">(IPMs, <a href="#ref-schaub2021" role="doc-biblioref">Schaub and Kéry 2021</a>)</span>. Through joint analysis of multiple datasets, IPMs allow simultaneous estimation of population size and composition, as well as all vital rates that form part of an underlying age- or stage-structured population model. Since both DS models and IPMs estimate population size/density, a combination of the two frameworks has the potential to provide good estimates of both population- and demographic parameters by maximizing knowledge gained from transect surveys by augmenting them with other available data <span class="citation" data-cites="schmidt2020">(e.g. <a href="#ref-schmidt2020" role="doc-biblioref">Schmidt and Robison 2020</a>)</span>.</p>
<p>In this study, we present a new IPM (IDSM, integrated distance sampling model) which integrates data from line transect distance sampling survey data and survival data from marked birds. The model’s core is a stage-structured matrix population model that projects population size from one time step to the next based on underlying survival and recruitment rates. Below, we first present the model and assess its robustness and performance through application to simulated data. We then apply the model to real data collected from a willow ptarmigan (<em>Lagopus lagopus</em>) study in Central Norway. Because demographic rates are often affected by environmental covariates (e.g.&nbsp;rodent abundance in the case of willow ptarmigans), we also illustrate how such covariates can be included in the modelling framework.</p>
</section>
<section id="methods" class="level2">
<h2 class="anchored" data-anchor-id="methods">2. Methods</h2>
<section id="an-integrated-distance-sampling-model" class="level3">
<h3 class="anchored" data-anchor-id="an-integrated-distance-sampling-model">2.1 An integrated distance sampling model</h3>
<p>Our open population integrated distance sampling model (IDSM) consists of two major components: a latent structured population model and a set of likelihoods for data originating from distance sampling surveys and auxiliary survival monitoring. In the example case, these auxiliary data come from a radio-telemetry study, but in principle other types of capture-recapture data can also be used.</p>
<section id="age-structured-population-model" class="level4">
<h4 class="anchored" data-anchor-id="age-structured-population-model">2.1.1 Age-structured population model</h4>
<p>The population model follows a post-breeding census and includes two age classes: juveniles (young of the year) and adults (&gt; 1 year of age, <a href="#fig-model">Figure&nbsp;1</a>). This structure is inspired by earlier models for our focal species, the willow ptarmigan (+ref), and is commonly used for populations of passerine and game birds <span class="citation" data-cites="williams2002 schaub2021">(<a href="#ref-williams2002" role="doc-biblioref">Williams, Nichols, and Conroy 2002</a>; <a href="#ref-schaub2021" role="doc-biblioref">Schaub and Kéry 2021</a>)</span>. In the context of our willow ptarmigan case study (see below), the census falls into late summer and coincides with the annual distance-sampling survey in August.</p>
<p>Both juveniles and adults survive from year <span class="math inline">\(t\)</span> census to year <span class="math inline">\(t+1\)</span> census with survival probability <span class="math inline">\(S_t\)</span>. As ptarmigan can reproduce already as 1-year old, all survivors then produce offspring in late June which recruit into the population as juveniles just prior to the census in year <span class="math inline">\(t+1\)</span> according to a recruitment rate <span class="math inline">\(R_{t+1}\)</span>. The changes in densities (numbers) of juveniles and adults in the population, <span class="math inline">\(D_{juv}\)</span> and <span class="math inline">\(D_{ad}\)</span>, can thus be expressed as</p>
<p><span class="math display">\[
\begin{aligned}
  D_{juv, t+1} &amp; = D_{ad,t+1} * R_{t+1} \\
  D_{ad, t+1} &amp; = S_t * (D_{juv,t} + D_{ad, t})  
\end{aligned}
\]</span></p>
<p>or, alternatively, in matrix notation as</p>
<p><span class="math display">\[
\left[
\begin{array}{}
D_{juv,t+1} \\
D_{ad,t+1}
\end{array}
\right]
=
\left[
\begin{array}{cc}
S_t*R_{t+1} &amp; S_t*R_{t+1}\\
S_t &amp; S_t
\end{array}
\right]
\left[\begin{array}{}
D_{juv,t} \\
D_{ad,t}
\end{array}\right]
\]</span></p>
<p>Note that recruitment rate <span class="math inline">\(R\)</span> is defined as juveniles/adult (not juveniles/female). We also make the simplifying assumption that there is no age- or sex-dependence of vital rates, but this assumption could be relaxed by including additional auxiliary data <span class="citation" data-cites="Israelsen2020 Sandercock2011">(<a href="#ref-Israelsen2020" role="doc-biblioref">Israelsen et al. 2020</a>; <a href="#ref-Sandercock2011" role="doc-biblioref">Sandercock et al. 2011</a>)</span>.</p>
<div id="fig-model" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="Figures/RypeIDSM_structure.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;1: Simplified graphical representation of the ptarmigan life cycle with two age classes and the data sources included in the integrated distance sampling model. Juv[t] = juveniles in year t. Ad[t] = adults in year t. R[t] = recruitment rate in year t. S[t] = survival probability from year t to t+1.</figcaption>
</figure>
</div>
</section>
<section id="likelihoods-for-distance-sampling-data" class="level4">
<h4 class="anchored" data-anchor-id="likelihoods-for-distance-sampling-data">2.1.2 Likelihoods for distance sampling data</h4>
<p>The implementation of the modelling framework we present makes three assumptions about the distance sampling survey: 1) the survey consists of line transects, 2) animals may be detected alone or in groups, and 3) juveniles and adults can be distinguished during surveys. These assumptions are inspired by our willow ptarmigan case study (details below). Our model includes three likelihoods for different components of the age-structured distance sampling data. First is the likelihood for the perpendicular detection distances from line transect, <span class="math inline">\(y\)</span>, which are linked to distance-dependent detection probability <span class="math inline">\(p\)</span> through a half-normal detection function:</p>
<p><span class="math display">\[
\begin{equation}
p = exp(-\frac{y^2}{2\sigma^2})
\end{equation}
\]</span> where <span class="math inline">\(\sigma\)</span> is the half-normal detection parameter. We assumed <span class="math inline">\(\sigma\)</span> to vary among years (index <span class="math inline">\(t\)</span>) but not between transect lines or animal group size. Following <span class="citation" data-cites="moore2011">Moore and Barlow (<a href="#ref-moore2011" role="doc-biblioref">2011</a>)</span>, the resulting <span class="math inline">\(\sigma_t\)</span> can be used to calculate effective strip width (<span class="math inline">\(esw_{t}\)</span>) and, consequently, average detection probability per line transect with a truncation distance <span class="math inline">\(W\)</span> according to:</p>
<p><span class="math display">\[
\begin{aligned}
  esw_t &amp; = \sqrt{\frac{\pi * \sigma_{t}^2}{2}}  \\
  \hat{p_t} &amp; = esw_t/W
\end{aligned}
\]</span> The average detection probability <span class="math inline">\(\hat{p_t}\)</span> is an integral part of the second data likelihood which relates the observed number of animals in each age class <span class="math inline">\(a\)</span>, <span class="math inline">\(obsN_{a,j,t}\)</span> (<span class="math inline">\(j\)</span> = transect) to the corresponding true number per transect, <span class="math inline">\(N_{a,j,t}\)</span>:</p>
<p><span class="math display">\[
\begin{equation}
  obsN_{a,j,t} \sim Poisson(\hat{p_t}*N_{a,j,t})
\end{equation}
\]</span> <span class="math inline">\(N_{juv,j,t}\)</span> and <span class="math inline">\(N_{ad,j,t}\)</span> are then linked back to the population model by converting them to densities through multiplication with <span class="math inline">\(2L_{j,t}W\)</span> (where <span class="math inline">\(L_{j,t}\)</span> is length of transect <span class="math inline">\(j\)</span> in year <span class="math inline">\(t\)</span>, and <span class="math inline">\(W\)</span> is the truncation distance).</p>
<p>The third data likelihood focuses on the counts of adults (<span class="math inline">\(obsAd_{j,t}\)</span>) and juveniles (<span class="math inline">\(obsJuv_{j,t}\)</span>) observed during the distance sampling surveys and links them to year-specific recruitment rate:</p>
<p><span class="math display">\[
\begin{equation}
  obsJuv_{j,t} \sim Poisson(R_t*obsAd_{j,t})
\end{equation}
\]</span></p>
</section>
<section id="likelihood-for-radio-telemetry-data" class="level4">
<h4 class="anchored" data-anchor-id="likelihood-for-radio-telemetry-data">2.1.3 Likelihood for radio-telemetry data</h4>
<p>The final likelihood is for the auxiliary telemetry data. It is set up under the assumption of perfect detection, and hence known fates, of animals bearing transmitters and links the numbers of animals released at the start of season <span class="math inline">\(k\)</span> of year <span class="math inline">\(t\)</span> to the number of survivors at the end of the same season:</p>
<p><span class="math display">\[
\begin{equation}
  survivors_{k,t} \sim Binomial(released_{k,t}, Sk_t)
\end{equation}
\]</span> Here, <span class="math inline">\(Sk_t\)</span> is the seasonal survival probability, and annual survival probability, <span class="math inline">\(S_t\)</span> is calculated as <span class="math inline">\(S1_t * S2_t\)</span>.</p>
</section>
<section id="hierarchical-models-with-time-variation-in-parameters" class="level4">
<h4 class="anchored" data-anchor-id="hierarchical-models-with-time-variation-in-parameters">2.1.3 Hierarchical models with time-variation in parameters</h4>
<p>Vital rates (survival probabilities <span class="math inline">\(S\)</span>, recruitment rates <span class="math inline">\(R\)</span>), detection parameters (half-normal detection parameters <span class="math inline">\(\sigma\)</span>), and initial population densities can all be modelled as time-dependent in our framework. For both the tests with simulated data and the case study described below, we implemented log-normally distributed random year effects on all parameters except survival, which was set to be constant. In the case study, we additionally included an effect of rodent occupancy (see details below) on log recruitment rates, resulting in the following model:</p>
<p><span class="math display">\[
\begin{equation}
  log(R_t) = log(\mu_R) + \beta*RodentOcc_t + \epsilon_t
\end{equation}
\]</span> where <span class="math inline">\(\mu_R\)</span> is the baseline recruitment rate, <span class="math inline">\(\beta\)</span> the slope of the effect of rodent occupancy, and <span class="math inline">\(\epsilon_t\)</span> the normally distributed random effects.</p>
</section>
</section>
<section id="model-testing-with-simulated-data" class="level3">
<h3 class="anchored" data-anchor-id="model-testing-with-simulated-data">2.2 Model testing with simulated data</h3>
<p>We assessed the model’s overall performance and ability to estimate abundance, demographic rates, and detection parameters without bias by testing it on simulated data. We generated a total of 10 simulated datasets in five steps. First, we simulated 15-year time-series of survival and recruitment rates from biologically plausible values for averages of and – in the case of recruitment – among-year variation in demographic rates (survival was held constant across years). Second, we used the yearly demographic rate and realistic initial population densities to simulate stochastic population dynamics in 50 distinct sites. Third, we simulated the grouping of individuals in each site by first determining the expected number of groups in a site (based on the average group size of 5.6 from our ptarmigan data) and then distributing individuals among groups via multinomial trials. Fourth, we assigned a distance from transect line to each group and simulated the line transect survey in all 50 sites across 15 years. Finally, we simulated 5-year time-series of radio-telemetry data (= survival from one year to the next) for a subset of individuals (30 on average) using the simulated survival probabilities for each relevant year. We then fit the IDSM to each of the 10 simulated datasets three times, using distinct seeds for both simulating initial values and initiating and running the MCMC. Model implementation for simulated data tests was largely identical to that for real data and is described in detail below.</p>
</section>
<section id="case-study" class="level3">
<h3 class="anchored" data-anchor-id="case-study">2.3 Case study</h3>
<p>The willow ptarmigan has a circumpolar distribution (Fuglei et al., 2020), and lives year-round in heterogeneous alpine and artic ecosystems. In Norway, there has been a long-term decline in the willow ptarmigan abundance across more than a century (ref), but in the last few decades abundance trends has fluctuated both in time and space. In Scandinavia, willow ptarmigan is a valued game species (ref), and there have been several long-term research projects devoted to understanding how they respond to environmental variation and harvest management <span class="citation" data-cites="Israelsen2020 Sandercock2011">(<a href="#ref-Israelsen2020" role="doc-biblioref">Israelsen et al. 2020</a>; <a href="#ref-Sandercock2011" role="doc-biblioref">Sandercock et al. 2011</a>)</span>. A key insight from across several study areas is the the annual recruitment rate (i.e.&nbsp;<span class="math inline">\(R_t\)</span> in our model, as outlined above) is highly variable, and is affected both by spring conditions <span class="citation" data-cites="Eriksen2023">(<a href="#ref-Eriksen2023" role="doc-biblioref">Eriksen et al. 2023</a>)</span> and the abundance of small rodents, which constitute alternative prey for common predators (i.e.&nbsp;the Alternative Prey Hypothesis ref). Adult survival show less inter-annual fluctuations <span class="citation" data-cites="Israelsen2020">(<a href="#ref-Israelsen2020" role="doc-biblioref">Israelsen et al. 2020</a>)</span>, although spatial (and potentially temporal) variation due to e.g.&nbsp;harvest management is evident when comparing across studies <span class="citation" data-cites="Israelsen2020">(<a href="#ref-Israelsen2020" role="doc-biblioref">Israelsen et al. 2020</a>)</span>.</p>
<p>Our case study was based on an ongoing long-term research project on willow ptarmigan in Lierne municipality in Central Norway (approximately 62.4 degrees north and 13.2 degrees east). The study area is located in a sub-alpine ecosystem, and the landscape is a mosaic of open heath and shrub vegetation (dominated by Ericacea, willow shrub <em>Salix spp</em>., and dwarf birch <em>Betula nana</em>), interspersed with bogs and forest patches (mainly birch <em>Betula spp</em>.). The climate is strongly seasonal, with snow typically covering the ground from October/November through April/May.</p>
<p>From this study system, two datasets were used for the case study:</p>
<ol type="1">
<li><p>Data from a line transect survey program targeting willow ptarmigan operated under the natural resources management authorities (2007-2021, ongoing)</p></li>
<li><p>Data from an individual-based monitoring programme based on radio collared willow ptarmigan (2015-2021, ongoing)</p></li>
</ol>
<p>Line transect survey data were collected in August each year, prior to the annual autumn harvest season, as part of the program “Hønsefuglportalen”. Hønsefuglportalen is a national program for line transect surveys of tetraonid birds, and the effort is directed mainly towards willow ptarmigan habitats. In our case study, we used data from the western part of Lierne municipality. Line transects are surveyed by trained volunteers that use pointing dogs to locate the birds. When located, the geographical coordinate, perpendicular distance from the sampling line, the number of birds in the group, as well as the age (juvenile or adult) and sex of the birds are recorded. As the surveys are conducted in early August, juveniles can be distinguished from adults by their smaller body size. <!-- maybe also mention how males and females are distinguished? Also, is it just body size for the juveniles or also plumage? --> Nevertheless, mis-identification can occur, and in addition a proportion of the birds are registered as “unknown” age and/or sex. Since 2019, data has been collected through a mobile app tailormade for this project <!-- Add name + maybe link to download in app store? --> . Before 2019, field workers reported their data through a dedicated web portal. After data are collected and reported, they undergo several steps of quality control: first by local contacts and subsequently by personnel at the Norwegian Institute for Nature Research (NINA). The data are then standardized based on the Darwin-Core standard (ref), and made publicly available as a sampling-event data set published through GBIF <span class="citation" data-cites="Nilsen2023a">(<a href="#ref-Nilsen2023a" role="doc-biblioref">Nilsen et al. 2023</a>)</span>. For additional description of the data collection procedures, see <span class="citation" data-cites="Bowler2020">(<a href="#ref-Bowler2020" role="doc-biblioref">Bowler et al. 2020</a>)</span>; [<span class="citation" data-cites="Kvasnes2018">Kvasnes, Pedersen, and Nilsen (<a href="#ref-Kvasnes2018" role="doc-biblioref">2018</a>)</span>]<span class="citation" data-cites="Nilsen2023a">(<a href="#ref-Nilsen2023a" role="doc-biblioref">Nilsen et al. 2023</a>)</span>.</p>
<p>The individual longitudinal study based on radio collared willow ptarmigan was conducted in 2015-2020. <!-- Above you stated that radio telemetry data collection is until 2021 and ongoing. Until what year was it? --> Each winter (in February-March), willow ptarmigan were located at night using snowmobiles and large hand nets with prolonged handles, as described in <span class="citation" data-cites="Israelsen2020">(<a href="#ref-Israelsen2020" role="doc-biblioref">Israelsen et al. 2020</a>)</span>. To prevent birds from flying off before the field personnel were close enough to capture them, a high-powered head lamp was used to dazzle the birds. After capture, birds were placed in an opaque bag to reduce stress. They were then fitted with a uniquely numbered leg ring (~ 2.4g) and a Holohil RI-2BM or Holohil RI-2DM radio transmitter (~ 14.1g) and subsequently released. The radio transmitters had an expected battery lifetime of 24 months (RI-2BM) or 30 months (RI-2DM), and included a mortality circuit that was activated if a bird had been immobile for 12 hours. We monitored the birds throughout most of the year by triangulation from the ground at least once a month for 10 months of the year (February – November) by qualified field personnel. If a mortality signal was emitted from a transmitter, we attempted to recover it as soon as possible to determine cause of death. A number of birds dispersed out of the main study areas and was thus out of signal range for field personnel on the ground. To avoid loss of data, we conducted aerial triangulation using a helicopter or airplane three times a year (May, September and November) in the years 2016-2020.</p>
</section>
<section id="bayesian-model-implementation" class="level3">
<h3 class="anchored" data-anchor-id="bayesian-model-implementation">2.4 Bayesian model implementation</h3>
<p>We implemented the model in a Bayesian framework using NIMBLE version 1.0.1 <span class="citation" data-cites="valpine2017">(<a href="#ref-valpine2017" role="doc-biblioref">Valpine et al. 2017</a>)</span> in R version 4.3.1 <span class="citation" data-cites="R2023">(<a href="#ref-R2023" role="doc-biblioref">R Core Team 2023</a>)</span>. The likelihood for line transect observation distances was set up using a custom half-normal distribution developed by Michael Scroggie as part of the “nimbleDistance” package (https://github.com/scrogster/nimbleDistance). We used non-informative uniform priors (with biologically reasonable boundaries where possible) for all parameters. We assumed constant survival and time-varying recruitment rate in models fit to both simulated and real data.</p>
<p>For the model fits to simulated and real data we ran 3 and 4 MCMC chains with NIMBLE’s standard samples for 500k and 100k iterations, respectively. 300k and 40k and thereof were discarded as burn-in prior to thinning with factors 5 and 20 , leaving us with 40k and 3k posterior samples per chain (total of 120k and 12k samples per run), repectively.</p>
</section>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">3. Results</h2>
<section id="model-performance-on-simulated-datasets" class="level3">
<h3 class="anchored" data-anchor-id="model-performance-on-simulated-datasets">3.1 Model performance on simulated datasets</h3>
<p>Posterior distributions for parameters estimated in three model fits to each of 10 simulated data sets are shown in <a href="#fig-sim-detection">Figure&nbsp;2</a> and <a href="#fig-sim-demo">Figure&nbsp;3</a>. Overall, the IDSM was able to corretly estimate both detection parameters and demographic rate parameters from all 10 simulated datasets without any systematic bias. The replicate runs for each dataset resulted in very similar posterior distributions, demonstrating that the models converged towards the same posterior distributions irrespective of starting values. Estimates of population sizes / densities were also adequate, and are presented in the Supplementary Materials (see folder SimCheck_byDataSet).</p>
<div id="fig-sim-detection" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="Figures/SimCheck_Detects_Temps.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;2: Detection parameters estimated from 10 distinct sets of simulated data (= colors). Upper panel depicts model parameters, and lower panels show derived estimated of effective strip width and mean detection probability. Dots represents true values (black for global values, colored for dataset-specific values), and density plot represent the posterior distributions for each model run.</figcaption>
</figure>
</div>
<div id="fig-sim-demo" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="Figures/SimCheck_VRs_Temps.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;3: Demographic rate parameters estimated from 10 distinct sets of simulated data (= colors). Upper panel show annual and seasonal survival probabilities, hyperparameters for the random effects model for recruitment (mean and sd), and lower panel show annual estimates of the recruitment rate. Dots represent true values (black for global values, colored for dataset-specific values), and density curves represent the posterior distributions from each model run.</figcaption>
</figure>
</div>
</section>
<section id="case-study-on-willow-ptarmigans-in-central-norway" class="level3">
<h3 class="anchored" data-anchor-id="case-study-on-willow-ptarmigans-in-central-norway">3.2 Case study on willow ptarmigans in Central Norway</h3>
<p>Having evaluated the overall performance of our model on simulated data, we used data from our case study in Lierne as a case study to estimate abundance, vital rates and detection probabilities from a real-world data set. Ptarmigan population density increased markedly across the study period, from &lt; 10 ptarmigan / <span class="math inline">\(km^{2}\)</span> in 2007 to &gt; 35 ptarmigan / <span class="math inline">\(km^{2}\)</span> in in 2021 (<a href="#fig-lierne-density">Figure&nbsp;4</a>). The increase was most distinct from 2016 and onward.</p>
<div id="fig-lierne-density" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="Figures/TimeSeries_popDens.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;4: Estimated density of willow ptarmigans in Lierne from 2007 to 2021. Solid line represents the posterior median, ribbon marks 95% credible interval.</figcaption>
</figure>
</div>
<p>Average survival probability for August - January (<span class="math inline">\(S_1\)</span>) was estimated at 0.46 (95% C.I = 0.42 - 0.51) while average survival probability for February - July (<span class="math inline">\(S_2\)</span>) was estimated as 0.64 (95% C.I = 0.59 - 0.7) (<a href="#fig-lierne-demo">Figure&nbsp;5</a> A). Annual survival probability <span class="math inline">\(S\)</span>, given by the product of <span class="math inline">\(S_1\)</span> and <span class="math inline">\(S_2\)</span>, was estimated at 0.3 (95% C.I = 0.29 - 0.31), <a href="#fig-lierne-demo">Figure&nbsp;5</a> A).</p>
<p>Recruitment (<span class="math inline">\(R_t\)</span>) was allowed to vary across years (see model specification), and estimates displayed large inter-annual variability (<a href="#fig-lierne-demo">Figure&nbsp;5</a> C, Figure S1). While the mean (baseline) recruitment <span class="math inline">\(\mu_R\)</span> was estimated as 2.9 (95% C.I = 2.5 - 3.4) the yearly recruitment rates ranged from 1.2 in year 2012 to 4.9 in year 2007.</p>
<p>Given the available data, the IDSM was not able to estimate a clear effect of small rodent abundance on ptarmigan recruitment (slope-paramater for the z-standardized rodent occurrence data = 0.037 ; 95% C.I. = -0.216 - 0.248).</p>
<div id="fig-lierne-demo" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="Figures/PostDens_Mu_S_tR.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;5: Posterior densities of A) seasonal survival, B) average annual survival, and C) recruitment rate. For the latter, the yellow distribution is for the intercept, representing a baseline recruitment rate when rodent occupancy is low. The turquoise distributions are for year-specific estimates or recruitment rate, with darker colors indicating later years.</figcaption>
</figure>
</div>
</section>
</section>
<section id="discussion" class="level2">
<h2 class="anchored" data-anchor-id="discussion">Discussion</h2>
<ul>
<li>In general, the model does a very good job in recreating the underlying parameters when fitted to simulated data where the true values are known. For the simulated data, a relative wide range of parameter values were allowed, and we did not detect any particular problems or biases with respect to this variation in the underlying parameters.</li>
<li>Both simulated data tests and real data application have shown that mixing is suboptimal for the average recruitment rate parameter (Mu.R). Future work should perhaps look into optimizing sampling? (For biological interpretation that is not a big problem as the yearly recruitment rate estimates are fine… but have to keep in mind when interpreting) <!-- I leave it to you Erlend to decide where, whether, and how much you want to go into this one --></li>
<li>The fact that this formulation allow us to separately estimate the underlying demographic rates (survival and recruitment) is a clear improvement compared to previous open population DS models, as this allow us both to obtain estimates of the rates, but also to assess the effect of environmental variation directly on demographic rates and not just on population growth rate (<span class="math inline">\(\lambda\)</span>) .</li>
<li>Nevertheless, we did not detect a clear effect of rodent abundance (indexed by the occurrence of rodents on the transect lines) on recruitment rate. This might be somewhat surprising, given that such a pattern has been reported repeatedly in the literature (see e.g. <span class="citation" data-cites="Bowler2020">Bowler et al. (<a href="#ref-Bowler2020" role="doc-biblioref">2020</a>)</span>). However, the data on rodent abundance was heavily zero-inflated, and the annual variation in the index was rather small. [A few sentences about fading rodent cycles, and perhaps a weakened link to ptarmigan dynamics]. [Also: a time-series of 15 years is still relatively short, so it is to be expected that we have low statistical power to detect temporal covariate effects –&gt; more years of data, or space-for-time substitution, will help)</li>
<li>In our process model, the population growth rate (<span class="math inline">\(\lambda\)</span>) is determined by the survival and recruitment rate in the following way: <span class="math inline">\(\lambda = S + (S * R)\)</span>, creating a dependence between the demographic parameters. If the age ratio in the data are biased or contain frequent misclassifications, this is likely to affect the relative contribution of survival and recruitment to the growth rate. As a test of the phenomena, we also assessed how sensitive the model output was with regard to the treatment of birds classified as “unknown sex and age” by the field personnel (see <strong>Methods</strong>). In the version presented in the results section, we made the assumption that these birds were in fact juveniles. In an alternative scenario, we discarded all birds classified as unknowns, and rerun the model (Appendix). As expected the estimated population density was virtually unaffected by this decision, whereas the effect on the demographic parameters were somewhat more affected. Thus biases in the age ratio will affect the demographic rates, but not so much the estimated density. Compared to previous studies on ptarmigan, we could have expected a higher survival rate indicating that there is some misclassification in the data with respect to age specification.</li>
<li>The model is flexible, and can be extended with additional auxiliary data, such as separate data on recruitment rates that could improve the precision of the demographic rate estimates. Another one might be data that allows to distinguish between true and apparent survival<!-- or is that accounted for in the telemetry data, i.e. are the individuals that left hte study area censored? -->. It is also possible to extent the model with additional covariates, to gain a better understanding of how species respond to environmental variation through the effects on vital rates. [See my point above on limited statistical power with 15 years. Maybe could be good to link to the space-for-time substitution idea here and “tease” the extension to multi-area since the monitoring programme, at least for line transects, covers many more areas).</li>
</ul>
<section id="author-contributions" class="level3">
<h3 class="anchored" data-anchor-id="author-contributions">Author contributions</h3>
<p>EBN Lead - Drafted the model code; Lead - Wrote first version of ms; Lead - Data collection; Contributed - Modelling and analyses</p>
<p>CRN Lead - Updated, further developed, and finalized model code; Lead - Modelling and analyses; Contributed - Wrote first version of ms</p>
</section>
<section id="acknowledgements" class="level3">
<h3 class="anchored" data-anchor-id="acknowledgements">Acknowledgements</h3>
<p>We are grateful to field workers that collected the line transect data through the Hønsefuglportalen program. Fjellstyrene i Lierne contributed both to the line transect program and the field work related to the marked willow ptarmigan. Norwegian Environment Agency funded the projects (grant nrs <strong>TO BE ADDED</strong>). [+ additional people contributing to the various projects]</p>
<p>[Should we thank James for discussions etc.?]</p>
</section>
<section id="data-and-code-availability" class="level3 unnumbered">


</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">Data and code availability</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-Bowler2020" class="csl-entry" role="listitem">
Bowler, D. E., M. A. J. Kvasnes, H. C. Pedersen, B. K. Sandercock, and E. B. Nilsen. 2020. <span>“Impacts of Predator-Mediated Interactions Along a Climatic Gradient on the Population Dynamics of an Alpine Bird.”</span> Journal Article. <em>Proc R Soc</em> 287 (1941): 20202653. <a href="https://doi.org/10.1098/rspb.2020.2653">https://doi.org/10.1098/rspb.2020.2653</a>.
</div>
<div id="ref-buckland2015" class="csl-entry" role="listitem">
Buckland, Stephen T, Eric A Rexstad, Tiago André Marques, Cornelia Sabrina Oedekoven, et al. 2015. <em>Distance Sampling: Methods and Applications</em>. Vol. 431. Springer.
</div>
<div id="ref-Eriksen2023" class="csl-entry" role="listitem">
Eriksen, Lasse Frost, Thor Harald Ringsby, Hans Chr. Pedersen, and Erlend B. Nilsen. 2023. <span>“Climatic Forcing and Individual Heterogeneity in a Resident Mountain Bird: Legacy Data Reveal Effects on Reproductive Strategies.”</span> <em>Royal Society Open Science</em> 10 (5): 221427. <a href="https://doi.org/doi:10.1098/rsos.221427">https://doi.org/doi:10.1098/rsos.221427</a>.
</div>
<div id="ref-Israelsen2020" class="csl-entry" role="listitem">
Israelsen, Markus F, Lasse F Eriksen, Pål F Moa, Bjørn Roar Hagen, and Erlend B Nilsen. 2020. <span>“Survival and Cause-Specific Mortality of Harvested Willow Ptarmigan (Lagopus Lagopus) in Central Norway.”</span> <em>Ecology and Evolution</em> 10 (20): 11144–54. <a href="https://doi.org/10.1002/ece3.6754">https://doi.org/10.1002/ece3.6754</a>.
</div>
<div id="ref-Kissling2018" class="csl-entry" role="listitem">
Kissling, W. Daniel, Jorge A. Ahumada, Anne Bowser, Miguel Fernandez, Néstor Fernández, Enrique Alonso García, Robert P. Guralnick, et al. 2018. <span>“Building Essential Biodiversity Variables (EBVs) of Species Distribution and Abundance at a Global Scale.”</span> Journal Article 93 (1): 600–625. <a href="https://doi.org/10.1111/brv.12359">https://doi.org/10.1111/brv.12359</a>.
</div>
<div id="ref-Kvasnes2018" class="csl-entry" role="listitem">
Kvasnes, M. A. J., H. C. Pedersen, and E. B. Nilsen. 2018. <span>“Quantifying Suitable Late Summer Brood Habitats for Willow Ptarmigan in Norway.”</span> Journal Article. <em>BMC Ecology</em> 18 (1): 41. <a href="https://doi.org/10.1186/s12898-018-0196-6">https://doi.org/10.1186/s12898-018-0196-6</a>.
</div>
<div id="ref-moore2011" class="csl-entry" role="listitem">
Moore, Jeffrey E, and Jay Barlow. 2011. <span>“Bayesian State-Space Model of Fin Whale Abundance Trends from a 1991–2008 Time Series of Line-Transect Surveys in the California Current.”</span> <em>Journal of Applied Ecology</em> 48 (5): 1195–205.
</div>
<div id="ref-Nilsen2018" class="csl-entry" role="listitem">
Nilsen, E. B., and O. Strand. 2018. <span>“Integrating Data from Multiple Sources for Insights into Demographic Processes: Simulation Studies and Proof of Concept for Hierarchical Change-in-Ratio Models.”</span> Journal Article. <em>PLoS One</em> 13 (3): e0194566. <a href="https://doi.org/10.1371/journal.pone.0194566">https://doi.org/10.1371/journal.pone.0194566</a>.
</div>
<div id="ref-Nilsen2023a" class="csl-entry" role="listitem">
Nilsen, E. B., R. Vang, M. Kjønsberg, and M. A. J. Kvasnes. 2023. <span>“Tetraonid Line Transect Surveys from Norway: Data from Fjellstyrene.”</span> Dataset. <a href="https://doi.org/10.15468/975ski">https://doi.org/10.15468/975ski</a>.
</div>
<div id="ref-R2023" class="csl-entry" role="listitem">
R Core Team. 2023. <em>R: A Language and Environment for Statistical Computing</em>. Vienna, Austria: R Foundation for Statistical Computing. <a href="https://www.R-project.org/">https://www.R-project.org/</a>.
</div>
<div id="ref-Sandercock2011" class="csl-entry" role="listitem">
Sandercock, Brett, Erlend B Nilsen, Henrik Brøseth, and Hans Chr Pedersen. 2011. <span>“Is Hunting Mortality Additive or Compensatory to Natural Mortality? Effects of Experimental Harvest on the Survival and Cause-Specific Mortality of Willow Ptarmigan.”</span> <em>Journal of Animal Ecology</em> 80 (1): 244–58. <a href="https://doi.org/10.1111/j.1365-2656.2010.01769.x">https://doi.org/10.1111/j.1365-2656.2010.01769.x</a>.
</div>
<div id="ref-schaub2021" class="csl-entry" role="listitem">
Schaub, Michael, and Marc Kéry. 2021. <em>Integrated Population Models: Theory and Ecological Applications with r and JAGS</em>. Academic Press.
</div>
<div id="ref-schmidt2020" class="csl-entry" role="listitem">
Schmidt, Joshua H, and Hillary L Robison. 2020. <span>“Using Distance Sampling-Based Integrated Population Models to Identify Key Demographic Parameters.”</span> <em>The Journal of Wildlife Management</em> 84 (2): 372–81.
</div>
<div id="ref-Skalski2005" class="csl-entry" role="listitem">
Skalski, John, Kristin Ryding, and Joshua Millspaugh. 2005. <em>Wildlife Demography: Analysis of Sex, Age, and Count Data</em>. Academic Press.
</div>
<div id="ref-sollmann2015" class="csl-entry" role="listitem">
Sollmann, Rahel, Beth Gardner, Richard B Chandler, J Andrew Royle, and T Scott Sillett. 2015. <span>“An Open-Population Hierarchical Distance Sampling Model.”</span> <em>Ecology</em> 96 (2): 325–31.
</div>
<div id="ref-valpine2017" class="csl-entry" role="listitem">
Valpine, Perry de, Daniel Turek, Christopher J Paciorek, Clifford Anderson-Bergman, Duncan Temple Lang, and Rastislav Bodik. 2017. <span>“Programming with Models: Writing Statistical Algorithms for General Model Structures with NIMBLE.”</span> <em>Journal of Computational and Graphical Statistics</em> 26 (2): 403–13.
</div>
<div id="ref-williams2002" class="csl-entry" role="listitem">
Williams, Byron K, James D Nichols, and Michael J Conroy. 2002. <em>Analysis and Management of Animal Populations</em>. Academic press.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>